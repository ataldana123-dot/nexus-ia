<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus IA - Oficial (2.5 Flash)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { 
            --bg: #030303; --side-bg: #080808; --card: #121214; --text: #ffffff;
            --primary: #0041C2; --accent-celeste: #0ea5e9; --gray: #1f1f22; 
            --download-btn: #238636; --accent-green: #10b981;
        }

        /* Reset para asegurar que ocupe toda la pantalla sin scroll extra */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg); color: var(--text); font-family: sans-serif; }

        body { display: flex; width: 100vw; }

        /* SIDEBAR: Ahora usa ancho fijo y transición de margen */
        #sidebar { 
            width: 280px; background: var(--side-bg); padding: 70px 15px 20px;
            border-right: 1px solid var(--gray); display: flex; flex-direction: column; gap: 15px;
            transition: margin-left 0.3s ease, opacity 0.3s; flex-shrink: 0;
            box-sizing: border-box;
        }
        
        /* Cuando colapsa, se mueve a la izquierda y desaparece el espacio */
        #sidebar.collapsed { margin-left: -280px; opacity: 0; pointer-events: none; }

        #toggle-menu {
            position: fixed; top: 15px; left: 15px; background: var(--card); 
            border: 1px solid var(--gray); color: white; width: 45px; height: 45px; 
            border-radius: 12px; cursor: pointer; z-index: 1000; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
        }

        h2 { text-align: center; color: var(--accent-celeste); margin-bottom: 10px; font-size: 1.8rem; letter-spacing: 2px; }

        .download-box {
            background: rgba(35, 134, 54, 0.1); border: 1px dashed var(--download-btn);
            padding: 12px; border-radius: 12px; text-align: center; margin-bottom: 10px;
        }
        .btn-download {
            display: block; background: var(--download-btn); color: white; 
            text-decoration: none; padding: 8px; border-radius: 8px; font-weight: bold; font-size: 11px;
        }

        /* MAIN: Ahora ocupa todo el espacio RESTANTE automáticamente */
        #main { 
            flex: 1; display: flex; flex-direction: column; height: 100%;
            position: relative; overflow: hidden; min-width: 0; /* Evita que el flex se rompa */
        }

        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; padding-top: 80px; }
        
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 15px; line-height: 1.5; font-size: 15px; word-wrap: break-word; }
        .ai { align-self: flex-start; background: var(--card); border: 1px solid var(--gray); }
        .user { align-self: flex-end; background: var(--primary); }

        .typing-bubble { align-self: flex-start; background: var(--card); border: 1px solid var(--gray); font-style: italic; color: #888; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        #input-area { padding: 20px; background: var(--bg); border-top: 1px solid var(--gray); display: flex; gap: 10px; }
        #user-input { flex: 1; background: #121214; border: 1px solid var(--gray); border-radius: 12px; color: white; padding: 12px; height: 45px; resize: none; outline: none; }
        #send-btn { background: var(--primary); color: white; border: none; width: 55px; border-radius: 12px; cursor: pointer; font-size: 20px; }

        .btn-new { background: var(--accent-green); color: white; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; }
        #chat-list { flex: 1; overflow-y: auto; }
        
        .chat-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; margin-bottom: 5px; background: rgba(255,255,255,0.05); 
            border-radius: 8px; cursor: pointer; font-size: 13px;
        }
        .chat-item.active { border-left: 4px solid var(--accent-celeste); background: rgba(14, 165, 233, 0.1); }
        .del-btn { color: #ff4d4d; border: none; background: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<button id="toggle-menu" onclick="toggleSidebar()">≡</button>

<div id="sidebar">
    <h2>NEXUS</h2>
    <div class="download-box">
        <a href="https://github.com/ataldana123-dot/nexus-ia/releases/download/v1.0.0/nexus-ia.1.0.0.exe" class="btn-download">DESCARGAR APP PC</a>
    </div>
    <button class="btn-new" onclick="createNewChat()">+ NUEVA CHARLA</button>
    <div id="chat-list"></div>
</div>

<div id="main">
    <div id="chat"></div>
    <div id="input-area">
        <textarea id="user-input" placeholder="Pregunta a Nexus 2.5 Flash..."></textarea>
        <button id="send-btn" onclick="sendMessage()">➔</button>
    </div>
</div>

<script>
    const MI_API_KEY = "AIzaSyB-cIOQ2cKKsqrND4jgwpBhJH7yfc-AiJ8";
    const MODELO = "gemini-2.5-flash"; // El nombre oficial de la API para la serie 2

    let chats = JSON.parse(localStorage.getItem('nexus_chats') || '{}');
    let currentId = null;

    function toggleSidebar() { 
        document.getElementById('sidebar').classList.toggle('collapsed');
    }

    function createNewChat() {
        const id = 'c_' + Date.now();
        chats[id] = { title: "Nueva charla", history: [] };
        saveData(); loadChat(id);
    }

    function deleteChat(id, event) {
        event.stopPropagation();
        if(Object.keys(chats).length <= 1) return alert("Mínimo un chat.");
        delete chats[id];
        saveData();
        if (currentId === id) loadChat(Object.keys(chats)[0]);
        else renderSidebar();
    }

    function loadChat(id) {
        currentId = id; renderSidebar();
        const box = document.getElementById('chat');
        box.innerHTML = '';
        if (chats[id].history.length === 0) {
            box.innerHTML = '<div class="msg ai">Nexus IA <b>2.5 Flash</b> lista.</div>';
        }
        chats[id].history.forEach(m => {
            const div = document.createElement('div');
            div.className = `msg ${m.role === 'user' ? 'user' : 'ai'}`;
            div.innerHTML = m.role === 'model' ? marked.parse(m.parts[0].text) : m.parts[0].text;
            box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    }

    function renderSidebar() {
        const list = document.getElementById('chat-list');
        list.innerHTML = Object.keys(chats).reverse().map(id => `
            <div class="chat-item ${id === currentId ? 'active' : ''}" onclick="loadChat('${id}')">
                <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px;">${chats[id].title}</span>
                <button class="del-btn" onclick="deleteChat('${id}', event)">✕</button>
            </div>
        `).join('');
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        const box = document.getElementById('chat');
        if(!text) return;

        if (chats[currentId].history.length === 0) chats[currentId].title = text.substring(0, 20);

        chats[currentId].history.push({ role: "user", parts: [{ text: text }] });
        input.value = '';
        loadChat(currentId);
        
        const loadingMsg = document.createElement('div');
        loadingMsg.className = "msg ai typing-bubble";
        loadingMsg.id = "temp-loading";
        loadingMsg.innerText = "Nexus 2.5 Flash está respondiendo...";
        box.appendChild(loadingMsg);
        box.scrollTop = box.scrollHeight;

        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODELO}:generateContent?key=${MI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: chats[currentId].history })
            });
            const d = await r.json();
            const reply = d.candidates[0].content.parts[0].text;
            chats[currentId].history.push({ role: "model", parts: [{ text: reply }] });
            saveData();
        } catch (e) {
            console.error(e);
        } finally {
            const temp = document.getElementById('temp-loading');
            if(temp) temp.remove();
            loadChat(currentId);
        }
    }

    function saveData() { localStorage.setItem('nexus_chats', JSON.stringify(chats)); renderSidebar(); }

    window.onload = () => {
        if (Object.keys(chats).length > 0) loadChat(Object.keys(chats).sort().reverse()[0]);
        else createNewChat();
    };

    document.getElementById('user-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
</script>
</body>
</html>
